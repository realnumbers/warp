function onBusstopClickSelectDestin(o){console.log("Selected Destination"),console.log(o);var s=o.target.options.stopId;switchToDepart(s)}function switchToDepart(o){$("#msg-depart").show(0),hideDestinMsg(),showDepartMsg(),markerGroup.clearLayers(),drawLine(o)}function onBusstopClickUnselectDestin(){console.log("Unselected Destination"),switchToDestin()}function switchToDestin(){$("#msg-destin").show(0),hideDestinMsg(),showDepartMsg(),markerGroup.clearLayers(),showBusstopMap()}function onBusstopClickDep(o){console.log("Selected Arr"),console.log(o);var s=o.target.options.stopId;$("#popup").empty(),$("<div class='spinner-container'><img class='spinner' src='images/spinner.svg'></div>").appendTo("#popup"),$(".top-msg").hide(),$(".info-bubble").css("background-color","rgba(255, 255, 255, 0)"),$(".darken").removeClass("hidden"),$(".popup").removeClass("hidden"),$(".info-bubble").addClass("hidden"),loadStationBoard(s)}function showBusstopMap(){for(var o=getBusstopList(),s=0;s<o.length;s++){var e=new Array;e[0]=parseFloat(o[s].busstops[0].ORT_POS_BREITE),e[1]=parseFloat(o[s].busstops[0].ORT_POS_LAENGE);var t=o[s].busstops[0].ORT_NR;drawStop(t,e,"#ff0101",onBusstopClickSelectDestin),void 0!=o[s].busstops[1]&&(e[0]=parseFloat(o[s].busstops[1].ORT_POS_BREITE),e[1]=parseFloat(o[s].busstops[1].ORT_POS_LAENGE),t=o[s].busstops[1].ORT_NR,drawStop(t,e,"#ff0101",onBusstopClickSelectDestin))}}function drawPositon(o){var s="#00ff00",e=L.circleMarker(o,{opacity:1,radius:15,color:s,fillOpacity:1,title:"Hello"}).addTo(markerGroup);map.fitBounds(e.getBounds())}function drawLine(o,s,e,t){for(var a=new Array,n=0;n<s.length;n++){if(e[t]===s[n].busstops[0].ORT_NR){a[0]=parseFloat(s[n].busstops[0].ORT_POS_BREITE),a[1]=parseFloat(s[n].busstops[0].ORT_POS_LAENGE);var r=parseFloat(s[n].busstops[0].ORT_NR);o===r?(arrival=s[n].ORT_NAME,drawStop(r,a,"#ff3101",onBusstopClickUnselectDestin)):drawStop(r,a,"#29b1ff",onBusstopClickDep)}if(void 0!=s[n].busstops[1]&&e[t]===s[n].busstops[1].ORT_NR){var r=parseFloat(s[n].busstops[1].ORT_NR);a[0]=parseFloat(s[n].busstops[1].ORT_POS_BREITE),a[1]=parseFloat(s[n].busstops[1].ORT_POS_LAENGE),o===r?(arrival=s[n].ORT_NAME,drawStop(r,a,"#ff3101",onBusstopClickUnselectDestin)):drawStop(r,a,"#29b1ff",onBusstopClickDep)}}t<e.length&&drawLine(o,s,e,t+1)}function drawStop(o,s,e,t){L.circleMarker(s,{opacity:1,radius:15,color:e,fillOpacity:1,stopId:o}).addTo(markerGroup).on("click",t)}function calcLine(o,s){var e=new Array,t=getBusstopList();console.log("Start calc");for(var a=0;a<s.length;a++)for(var n=0;n<s[a].varlist.length;n++){for(var r=0;r<s[a].varlist[n].routelist.length&&s[a].varlist[n].routelist[r]!=o;r++);s[a].varlist[n].routelist[r]===o&&(console.log("Merge"),e=$.merge(e,s[a].varlist[n].routelist))}drawLine(o,t,e,0)}function writeStationBoard(o){console.log(o);var s=(new Array,o[0].stationname);console.log(o[0]),$("#popup").empty(),$("<h2 class='popup-title' id='popup-title'><span class='blue depart'>"+chooseStationName(s)+"</span><img class='arrow' src='images/arrow.svg'><span class='red destin'>"+chooseStationName(arrival)+"</span></h2>").appendTo("#popup");for(var e=0;e<o.length&&5>e;e++){var t=o[e].arrival;t=moment(t,"hhmmss").endOf().fromNow(),t=t.replace("minutes","min"),t=t.replace("minute","min"),t=t.replace("in a few seconds","now"),t=t.replace("a few seconds ago","now"),$("	<section class='arriving-bus'><span class='bus-time ellipsis'>"+t+"</span><span class='bus-line-container ellipsis'><span class='bus-line'>"+o[e].lidname+"</span><span class='bus-line-endstation'>"+chooseStationName(o[e].last_station)+"</span></span><span class='destin-time'>09:3"+2*e%10+"</span></section>").appendTo("#popup")}}function switchToDepart(o){$("#msg-depart").show(0),hideDestinMsg(),showDepartMsg(),markerGroup.clearLayers(),calcLine(o,getLineStops())}function switchToDestin(){$("#msg-destin").show(0),hideDestinMsg(),showDepartMsg(),markerGroup.clearLayers(),showBusstopMap()}function loadStationBoard(o){var s="http://stationboard.opensasa.info/?ORT_NR="+o+"&type=jsonp";request(s,writeStationBoard,"JSONP")}function getBusstopList(){return JSON.parse(localStorage.busstops)}function getLineStops(){return JSON.parse(localStorage.line)}function UILang(){return"de"==navigator.language.substr(0,2)?"de":"it"}function currentPosition(){function o(o){coord[0]=o.coords.latitude,coord[1]=o.coords.longitude,drawPositon(coord)}function s(){console.log("Unable to retrieve your location, using default position")}navigator.geolocation?navigator.geolocation.getCurrentPosition(o,s):s()}function loadBusstopsList(){if(console.log("Start Request"),localStorage.busstops){var o="http://opensasa.info/SASAplandata/?type=BASIS_VER_GUELTIGKEIT";request(o,validitySuccess,"jsonp")}else{console.log("New Data");var o="http://opensasa.info/SASAplandata/?type=REC_ORT";request(o,busstopsSuccess,"jsonp")}}function validitySuccess(o){localStorage.version==o[0].VER_GUELTIGKEIT?loadLineStops():(localStorage.clear(),localStorage.version=o[0].VER_GUELTIGKEIT,loadBusstopsList())}function busstopsSuccess(o){localStorage.setItem("busstops",JSON.stringify(o)),console.log("Data"),console.log(o),loadLineStops()}function loadLineInfo(){var o="http://opensasa.info/SASAplandata/?type=REC_LID";request(o,infoSuccess,"jsonp")}function infoSuccess(o){for(var s=getLineStops(),e=0;e<o.length;e++)s[e].LIDNAME=o[e].LIDNAME,s[e].LI_KUERZEL=o[e].LI_KUERZEL;localStorage.setItem("line",JSON.stringify(s)),showBusstopMap()}function loadLineStops(){if(console.log("Start Request"),localStorage.line)showBusstopMap();else{console.log("New Data");var o="http://opensasa.info/SASAplandata/?type=LID_VERLAUF";request(o,lineSuccess,"jsonp")}}function lineSuccess(o){localStorage.setItem("line",JSON.stringify(o)),console.log("Data"),loadLineInfo()}function showDestinMsg(){console.log("show destination msg"),$("#msg-destin").removeClass("left").addClass("zero")}function hideDestinMsg(){console.log("hide destination msg"),$("#msg-destin").hide(),$("#msg-destin").removeClass("zero").addClass("left")}function showDepartMsg(){console.log("show departure msg"),$("#msg-depart").removeClass("right").addClass("zero")}function hideDepartMsg(){console.log("hide departure msg"),$("#msg-depart").hide(),$("#msg-depart").removeClass("zero").addClass("right")}function showMenu(){$(".darken").hasClass("hidden")?($(".about").removeClass("hidden"),$(".darken").removeClass("hidden"),$(".info-bubble").addClass("hidden"),$(".info-bubble").css("background-color","rgba(0, 0, 0, 0)")):blurForeground()}function blurForeground(){$(".about").addClass("hidden"),$(".darken").addClass("hidden"),$(".popup").addClass("hidden"),$(".info-bubble").css("background-color","rgba(0, 0, 0, 0.8)"),$("#popup").empty()}function cancelQuery(){window.location.reload()}function removeClickDelay(){window.addEventListener("load",function(){new FastClick(document.body)},!1)}function request(o,s,e){$.ajax({url:o,dataType:"jsonp",jsonp:e,success:function(e){console.log("success: "+o),s(e)},error:function(){console.log("Error: "+o)}})}function chooseStationName(o){return first=o.split("-")[0],second=o.split("-")[1],removeSpaces(first.length>3?first:second)}function removeSpaces(o){return" "===o[0]&&(o=o.slice(1,o.length))," "===o[o.length-1]&&(o=o.slice(0,o.length-1)),o}var coord=new Array,arrival="";coord=[46.4928,11.331],currentPosition();var map=L.map("map",{center:coord,zoom:16});L.tileLayer("http://{s}.tile.stamen.com/toner/{z}/{x}/{y}.png",{minZoom:12,maxZoom:18,attribution:'Map data Â© <a href="http://www.openstreetmap.org">OpenStreetMap contributors</a>'}).addTo(map);var markerGroup=(new L.LayerGroup).addTo(map);loadBusstopsList();